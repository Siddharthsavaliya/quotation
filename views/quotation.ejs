<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotation - Ashok Extrusion Tech</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        @page {
            size: A4;
            margin: 10mm 15mm 10mm 15mm; /* reduced top, right, bottom, left */
        }

        body {
            background: #fff;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            position: relative;
        }

        .header-fixed {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 28mm;
            width: 100%;
            z-index: 1000;
            background: #fff;
            display: flex;
            justify-content: flex-end;
            align-items: flex-start;
            padding: 8mm 15mm 0 0;
        }

        .header-fixed img {
            width: 140px;
            height: auto;
        }

        .footer-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 22mm;
            width: 100%;
            z-index: 1000;
            background: #fff;
            text-align: center;
            padding: 0 15mm 2mm 15mm;
            box-sizing: border-box;
        }

        .footer-address {
            color: #888;
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 2px;
        }

        .footer-tagline {
            color: #011BB6;
            font-size: 16px;
            font-weight: bold;
            margin-top: 4px;
            margin-bottom: 0;
            text-align: center;
            letter-spacing: 0.5px;
        }

        .page {
            width: 100%;
            min-height: 230mm;
            box-sizing: border-box;
            page-break-after: always;
            padding-top: 40mm; /* header height + extra gap to avoid cut-off */
            padding-bottom: 24mm; /* footer height + some gap */
        }

        .page:last-child {
            padding-bottom: 35mm;
        }

        .page-number {
            position: absolute;
            bottom: 10mm;
            right: 15mm;
            font-size: 12px;
            color: #666;
            z-index: 1;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            border-bottom: 2px solid #011BB6;
            padding-bottom: 15px;
        }

        .logo {
            width: 180px;
            height: auto;
        }

        .quotation-info {
            text-align: right;
            font-size: 13px;
            line-height: 1.5;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
        }

        .sales-person {
            text-align: right;
            margin-bottom: 25px;
            font-size: 13px;
            line-height: 1.5;
            color: #444;
        }

        .quotation-to {
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
        }

        .quotation-to h3 {
            margin-bottom: 10px;
            font-size: 15px;
            color: #011BB6;
            border-bottom: 2px solid #011BB6;
            padding-bottom: 5px;
            display: inline-block;
        }

        .quotation-to p {
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 3px;
            color: #444;
        }

        .subject-line {
            margin-bottom: 20px;
        }

        .subject-line p {
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 8px;
            color: #444;
        }

        .annexure-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: #f8f9fa;
            border-radius: 4px;
            overflow: hidden;
        }

        .annexure-table tr {
            border-bottom: 1px solid #ddd;
        }

        .annexure-table tr:last-child {
            border-bottom: none;
        }

        .annexure-table td {
            padding: 12px;
            font-size: 13px;
            line-height: 1.4;
            color: #444;
        }

        .blue-header {
            background-color: #011BB6;
            color: white;
            padding: 12px 15px;
            margin: 0 0 15px 0;
            border-radius: 4px;
        }

        .blue-header h2 {
            font-size: 16px;
            font-weight: bold;
            margin: 0;
            line-height: 1.2;
        }

        .technical-table,
        .financial-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .technical-table th,
        .technical-table td,
        .financial-table th,
        .financial-table td {
            border: 1px solid #ddd;
            padding: 10px 12px;
            font-size: 13px;
            line-height: 1.4;
            color: #444;
        }

        .technical-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            text-align: left;
            color: #011BB6;
        }

        .terms-content {
            white-space: pre-wrap;
            line-height: 1.5;
            font-size: 13px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            color: #444;
            margin-bottom: 30px;
        }

        .footer {
            position: absolute;
            bottom: 10mm;
            left: 15mm;
            right: 15mm;
            text-align: center;
            padding-top: 10px;
            border-top: 2px solid #011BB6;
            background: white;
        }

        .footer p {
            margin: 2px 0;
            color: #011BB6;
            font-size: 11px;
            line-height: 1.4;
        }

        .section-title {
            font-size: 15px;
            font-weight: bold;
            color: #011BB6;
            padding-bottom: 8px;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .financial-table tr:last-child {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .financial-table tr:last-child td {
            border-top: 2px solid #011BB6;
        }

        .machine-details {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .machine-section {
            background: white;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .machine-section:last-child {
            margin-bottom: 0;
        }

        .total-summary {
            margin-top: 30px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-top: 2px solid #011BB6;
        }

        .total-summary .section-title {
            color: #011BB6;
            margin-top: 0;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0 0 0;
        }

        .summary-table td {
            padding: 8px 12px;
            font-size: 13px;
            line-height: 1.4;
        }

        .summary-table tr:last-child {
            font-weight: bold;
            font-size: 14px;
            border-top: 2px solid #011BB6;
        }

        .summary-table tr:last-child td {
            padding-top: 12px;
        }

        .technical-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        @media print {
            body {
                width: 210mm;
                height: 297mm;
                margin: 0;
                padding: 0;
            }

            .page {
                margin: 0;
                padding: 15mm;
                border: initial;
                border-radius: initial;
                width: initial;
                min-height: initial;
                box-shadow: initial;
                background: initial;
                page-break-after: always;
                position: relative;
            }

            table {
                page-break-inside: auto;
            }

            tr {
                page-break-inside: avoid;
            }

            thead {
                display: table-header-group;
            }

            .page-number {
                position: absolute;
                background: none;
                padding: 0;
            }

            .page:last-child .page-number {
                bottom: 35mm;
            }
        }
    </style>
</head>

<body>
    <!-- Fixed Header -->
    <div class="header-fixed">
        <img src="https://ashokextrusiontech.com/images/Ashok-blue-web.png" alt="Ashok Extrusion Tech">
    </div>
    <!-- Fixed Footer -->
    <div class="footer-fixed">
        <div class="footer-address">
            984, Makarpura GIDC, Vadodara â€“ 390010. Gujarat, India.<br>
            Website: <a href='https://www.ashokextrusiontech.com' style='color:#888; text-decoration:underline;'>www.ashokextrusiontech.com</a> |
            Email: <a href='mailto:info@ashokextrusiontech.com' style='color:#888; text-decoration:underline;'>info@ashokextrusiontech.com</a>
        </div>
        <div class="footer-tagline">
            Superior Quality Film with unrivalled Support
        </div>
    </div>
    <!-- First Page -->
    <div class="page">
        <div style="flex:1;">
            <div style="margin-top:100px; margin-bottom:0;">
                <p style="color:#011BB6; font-weight:bold; margin-bottom:6px; font-size:16px; line-height:1.3;">Date: <span style="font-weight:normal; color:#222;"> <%= (new Date()).toLocaleDateString('en-GB').split('/').join('-') %></span></p>
                <p style="color:#011BB6; font-weight:bold; margin-bottom:6px; font-size:16px; line-height:1.3;">Quotation No.: <span style="font-weight:normal; color:#222;"> <%= formNumber %></span></p>
                <p style="color:#011BB6; font-weight:bold; margin-bottom:6px; font-size:16px; line-height:1.3;">Kind Attn.:</p>
                <p style="color:#011BB6; font-weight:bold; margin-bottom:6px; font-size:16px; line-height:1.3;">Sub.: Technical and Financial Details for Extruder Blown Film Plant</p>
                <p style="color:#011BB6; font-weight:bold; font-style:italic; margin-bottom:6px; font-size:16px; line-height:1.3;">Model: <%= machines[0].machine.name %></p>
                <p style="color:#011BB6; font-weight:bold; margin-bottom:6px; font-size:16px; line-height:1.3;">To.</p>
                <p style="margin-top:8px; color:#222; margin-bottom:18px; font-size:15px; line-height:1.6;">Apropos to your requirement in personal discussion regarding Blown Film Extruder Machine, we thank you for giving us the opportunity to work with you for supplying you the machine as per your requirement.</p>
            </div>
            <div style="margin-top:10px; margin-bottom:18px;">
                <p style="color:#011BB6; font-weight:bold; margin-bottom:8px; font-size:16px; line-height:1.3;">Key Benefits of business with Ashok Extrusion Tech Private Limited,</p>
                <ul style="margin-left:20px; margin-bottom:10px; color:#222; font-size:15px; line-height:1.6;">
                    <li style="margin-bottom:4px;">Bankable Project.</li>
                    <li style="margin-bottom:4px;">Controlled BOM with certified Components.</li>
                    <li style="margin-bottom:4px;">Total Solution with Installation and service.</li>
                    <li style="margin-bottom:4px;">Highest Efficiency of machine with certified components with 1 Year of Upfront warranty.</li>
                </ul>
            </div>
            <div style="margin-bottom:18px; color:#222; font-size:15px; line-height:1.6;">We have enclosed the following documents for your kind perusal:</div>
            <table style="width:100%; border-collapse:collapse; margin-top:10px; margin-bottom:30px; font-size:15px;">
                <tr style="background:#011BB6; color:#fff; font-weight:bold;">
                    <td style="border:1px solid #888; padding:8px; width:10%; text-align:center;">Sr. No.</td>
                    <td style="border:1px solid #888; padding:8px; width:60%; text-align:center;">Description</td>
                    <td style="border:1px solid #888; padding:8px; width:30%; text-align:center;">Page No.</td>
                </tr>
                <tr>
                    <td style="border:1px solid #888; padding:8px; text-align:center;">1</td>
                    <td style="border:1px solid #888; padding:8px; font-weight:bold;">Section 1: Technical Specifications</td>
                    <td style="border:1px solid #888; padding:8px;"></td>
                </tr>
                <tr>
                    <td style="border:1px solid #888; padding:8px; text-align:center;">2</td>
                    <td style="border:1px solid #888; padding:8px; font-weight:bold;">Section 2: Financial Quote</td>
                    <td style="border:1px solid #888; padding:8px;"></td>
                </tr>
                <tr>
                    <td style="border:1px solid #888; padding:8px; text-align:center;">3.</td>
                    <td style="border:1px solid #888; padding:8px; font-weight:bold;">Section 3: Terms and Conditions</td>
                    <td style="border:1px solid #888; padding:8px;"></td>
                </tr>
            </table>
            <div style="margin-top:32px;"></div>
            <div style="color:#011BB6; font-weight:bold; margin-bottom:6px; font-size:15px; line-height:1.5; padding:4px 0 4px 8px; width:max-content;">Please feel free for any further discussions.</div>
            <div style="color:#011BB6; font-weight:bold; margin-bottom:6px; font-size:15px; line-height:1.5; padding:4px 0 4px 8px; width:max-content;">Thank you and with best regards,</div>
            <div style="color:#011BB6; font-weight:bold; margin-bottom:6px; font-size:15px; line-height:1.5; padding:4px 0 4px 8px; width:max-content;">Ashok Extrusion Tech Private Limited.</div>
        </div>
    </div>

    <!-- Technical Proposal Pages -->
    <% machines.forEach((machineItem, machineIndex)=> { %>
        <div class="page">
            <div style="font-size:22px; color:#011BB6; font-weight:bold; margin-bottom:18px; margin-top:100px;">
                Section 1: Technical Specifications for <span style="font-style:italic; font-weight:normal;"><%= machineItem.machine.name %></span>
            </div>
            <% 
            // 1. Filter only section: 1 fields
            const mainFields = machineItem.machine.fields.filter(f => f.section === 1);
            // 2. Group by integer part of qFieldMain
            const sectionGroups = {};
            mainFields.forEach(field => {
                const mainSection = Math.floor(field.qFieldMain);
                if (!sectionGroups[mainSection]) sectionGroups[mainSection] = [];
                sectionGroups[mainSection].push(field);
            });
            const sortedMainSections = Object.keys(sectionGroups).sort((a, b) => parseInt(a) - parseInt(b));
            %>
            <% sortedMainSections.forEach(mainSection => { 
                const mainField = sectionGroups[mainSection].find(f => f.qFieldMain == mainSection);
                const mainFieldValueObj = mainField ? machineItem.fieldValues.find(fv => fv.fieldId.toString() === mainField._id.toString()) : null;
                const mainFieldValue = mainFieldValueObj && mainFieldValueObj.value ? mainFieldValueObj.value : (mainField ? (mainField.description || '') : '');
                const subFields = sectionGroups[mainSection].filter(f => f.qFieldMain != mainSection);
            %>
            <table style="width:100%; border-collapse:collapse; margin-bottom:30px;">
                <tr style="background:#011BB6; color:#fff; border:1px solid #011BB6;">
                    <td style="width:10%; font-weight:bold; font-size:18px; text-align:center; padding:10px 6px; border:1px solid #011BB6;"> <%= mainSection %> </td>
                    <td style="width:35%; font-weight:bold; font-size:17px; padding:10px 6px; text-transform:uppercase; border:1px solid #011BB6;"> <%= mainField ? mainField.title : '' %> </td>
                    <td style="font-weight:bold; font-size:15px; padding:10px 6px; border:1px solid #011BB6;"> <%= mainFieldValue %> </td>
                </tr>
                <% subFields.forEach(subField => {
                    const fieldValue = machineItem.fieldValues.find(fv => fv.fieldId.toString() === subField._id.toString());
                    if (fieldValue && fieldValue.value && fieldValue.value.toString().trim() !== '') {
                %>
                <tr style="background:#fff; color:#011BB6; border:1px solid #011BB6;">
                    <td style="text-align:center; font-weight:bold; padding:8px 6px; border:1px solid #011BB6;"> <%= subField.qFieldMain %> </td>
                    <td style="font-weight:bold; padding:8px 6px; border:1px solid #011BB6;"> <%= subField.title %> </td>
                    <td style="padding:8px 6px; border:1px solid #011BB6;"> <%= fieldValue.value %> </td>
                </tr>
                <% } }); %>
            </table>
            <% }); %>
        </div>
    <% }) %>

    <!-- Financial Proposal Page -->
    <div class="page">
        <div style="font-size:22px; color:#011BB6; font-weight:bold; margin-bottom:18px; margin-top:100px; display:inline-block; border-bottom: 4px solid #011BB6; line-height:1.1; padding-bottom:2px;">
            Section 2: Financial Quote
        </div>
        <table style="width:100%; border-collapse:collapse; margin-bottom:30px;">
            <tr style="background:#011BB6; color:#fff; border:1px solid #011BB6;">
                <td style="width:10%; font-weight:bold; font-size:16px; text-align:center; padding:8px 4px; border:1px solid #011BB6; text-transform:uppercase;">SR. NO.</td>
                <td style="width:50%; font-weight:bold; font-size:16px; text-align:center; padding:8px 4px; border:1px solid #011BB6; text-transform:uppercase;">DESCRIPTION</td>
                <td style="width:10%; font-weight:bold; font-size:16px; text-align:center; padding:8px 4px; border:1px solid #011BB6; text-transform:uppercase;">QTY</td>
                <td style="width:16%; font-weight:bold; font-size:16px; text-align:center; padding:8px 4px; border:1px solid #011BB6; text-transform:uppercase;">RATE</td>
                <td style="width:17%; font-weight:bold; font-size:16px; text-align:center; padding:8px 4px; border:1px solid #011BB6; text-transform:uppercase;">AMOUNT</td>
            </tr>
            <% 
            // Prepare up to 4 items for the table
            let items = [];
            machines.forEach((machineItem, idx) => {
                items.push({
                    sr: idx+1,
                    desc: machineItem.machine.name,
                    qty: 1,
                    rate: machineItem.totalPrice ? machineItem.totalPrice.toLocaleString() : '',
                    amount: machineItem.finalTotal ? machineItem.finalTotal.toLocaleString() : ''
                });
            });
            while(items.length < 4) items.push({sr: items.length+1, desc: '', qty: '', rate: '', amount: ''});
            let totalQty = items.reduce((sum, i) => sum + (parseInt(i.qty) || 0), 0);
            let totalAmount = items.reduce((sum, i) => sum + (parseInt(i.amount.replace(/,/g, '')) || 0), 0);
            %>
            <% items.forEach((item, idx) => { %>
            <tr style="border:1px solid #011BB6; color:#011BB6;">
                <td style="text-align:center; font-weight:bold; border:1px solid #011BB6; padding:8px 4px; font-size:15px;"><%= item.sr %></td>
                <td style="border:1px solid #011BB6; padding:8px 4px; font-size:15px;"><%= item.desc %></td>
                <td style="text-align:center; border:1px solid #011BB6; padding:8px 4px; font-size:15px;"><%= item.qty %></td>
                <td style="text-align:right; border:1px solid #011BB6; padding:8px 4px; font-size:15px;"><%= item.rate %></td>
                <td style="text-align:right; border:1px solid #011BB6; padding:8px 4px; font-size:15px;"><%= item.amount %></td>
            </tr>
            <% }); %>
            <tr style="border:1px solid #011BB6; color:#011BB6; font-weight:bold;">
                <td colspan="2" style="text-align:right; border:1px solid #011BB6; padding:8px 4px; font-size:15px;">TOTAL</td>
                <td style="text-align:center; border:1px solid #011BB6; padding:8px 4px; font-size:15px;"><%= totalQty %></td>
                <td style="border:1px solid #011BB6; padding:8px 4px; font-size:15px;"></td>
                <td style="text-align:right; border:1px solid #011BB6; padding:8px 4px; font-size:15px;"><%= totalAmount ? totalAmount.toLocaleString() : '' %></td>
            </tr>
        </table>
    </div>

    <!-- Terms & Conditions Page -->
    <div class="page">
        <div class="blue-header">
            <h2>ANNEXURE - <%= 1 + machines.length + 2 %> TERMS & CONDITIONS</h2>
        </div>

        <div class="terms-content">
            <%= terms %>
        </div>

    </div>
</body>

</html>